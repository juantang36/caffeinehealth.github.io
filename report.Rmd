---
title: "Report"
output: 
  html_document:
    code_folding: hide
    theme: flatly
    toc: true
    toc_float: true
---
```{css, echo=FALSE}
h2 {
  margin-top: 80px;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(plotly)
library(patchwork)
library(readr)
library(haven)
library(janitor)
library(ggplot2)
library(ggridges)
analytic = read_csv("./analytic.csv")
```


## Scientific Title
Exploring whether coffee is beneficial or harmful to human health by using the National Health and Nutrition Examination Survey (NHANES) datasets from the Centers for Disease Control and Prevention (CDC).


## Group Members
Disheng Jiang (dj2763), Juan Tang (jt3649), Ruhui Shen (rs4788), Yurou Liu (yl6109)


## Motivation
Coffee, as one of the most popular beverages in the world, is highly favored by people. Since the caffeine in coffee has a regulatory effect on the central nervous system (Herqutanto et al., 2024), coffee is widely consumed for alertness. The debate over whether coffee is beneficial or harmful to human health is long standing. Some researchers suggest that moderate coffee consumption may help reduce the risk of type 2 diabetes and cardiovascular disease, and may be associated with anti-inflammatory and antioxidant effects (Barrea et al., 2023). However, other studies indicate that coffee intake could potentially increase the risk of certain cancers and fractures (Asoudeh et al., 2023; Carter et al., 2022). We wanted to explore the relationship between coffee intake and health through the analysis of large amounts of data and identify a reasonable intake level.

NHANES is uniquely well-suited for this study. NHANES contains nationally representative sampling with detailed, standardized measurements that are directly relevant to caffeine. It also contains clinically measured outcomes like blood pressure, pulse and BMI, meanwhile providing rich covariates such as age, sex, physical activity, and socioeconomic markers. By utilizing the abundant raw data, we can learn about the effect of coffee on human health and dose-response patterns through data analysis and draw transparent and reproducible public health inferences.


## Related work
Our interest in coffee and health grew from prior coursework and lived experience. One member of our group studied food science as an undergraduate and had previously participated in a simple discussion about whether coffee is beneficial to health. Coffee is one of the most popular beverages among young people, and we are all very interested in this topic. As students in the School of Public Health, we have a strong desire to explore health-related issues. Therefore, when we received this project assignment, we believed it to be an excellent opportunity to apply our knowledge of statistics and data science to further investigate the questions on our minds.


## Initial questions
Our initial questions were structured to explore potential associations between coffee intake and health outcomes:

- Does coffee consumption affect indicators such as blood pressure, pulse rate, and sleep?
- Will coffee consumption influence relevant biomarkers and increase the risk of developing diabetes?
- Whether long-term coffee consumption increases or decreases the risk of cardiovascular disease?
- Is there a dose–response between caffeine intake and health outcomes?


## Data

#### NHANES Dataset

We used data from the **2021–2023 National Health and Nutrition Examination Survey (NHANES)**, an ongoing program conducted by the U.S. Centers for Disease Control and Prevention (CDC). NHANES combines interviews, physical examinations, and laboratory measurements to provide nationally representative information on the health and nutritional status of the U.S. population.

All data files are publicly available from the CDC website and can be downloaded here:  
[2021-2023 NHANES](https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?Cycle=2021-2023)

Our project draws on several NHANES data:

- **Demographic data**
- **Dietary data**
  - Individual Foods files for 24-hour recall across two non-consecutive days (DR1IFF, DR2IFF)
  - Total Nutrient Intakes (DR1TOT, DR2TOT)
- **Laboratory data**
  - Glycohemoglobin (GHB_L)
  - Plasma fasting glucose (GLU_L)
  - Insulin (INS_L)
  - Lipid panel: HDL (HDL_L), LDL (TRIGLY_L), total cholesterol (TCHOL_L)
- **Examination data**
  - Blood pressure and pulse data (BPXO_L)

---

#### Construction of the Analytic Dataset

The first major step in our workflow was to build **a single, unified “analytic” dataset** that contains all relevant NHANES variables merged into one table (`analytic.csv`). This file serves as the foundation for all subsequent analyses.

All datasets mentioned above were merged using the unique participant identifier `SEQN`.

---

#### Exposure Variable: Coffee Habit

Coffee intake was defined using the 24-hour dietary recall data and USDA food codes:

1. Food codes whose descriptions contained the keyword **“coffee”** were identified from the Individual Foods files.
2. For each participant, we determined whether coffee was consumed on Day 1 and Day 2.
3. Participants were then classified as:
   - **Yes**: consumed coffee on *both* dietary recall days  
   - **No**: did *not* consume coffee on either recall day  

Participants who consumed coffee on only one day were excluded from the binary “coffee habit” analyses. This yielded two key exposure variables:

- `coffee_habit_binary` (TRUE for Yes, FALSE for No)  
- `coffee_habit` (factor with levels “No”, “Yes”) used for visualization and statistical tests.

#### Caffeine Intake (Continuous Exposure for Regression)

In addition to coffee habit, we computed **total caffeine intake (mg/day)** to examine dose–response relationships. New variable `caffeine_mg` was calculated by averaging total caffeine intake on both recall days:
Average caffeine intake:

\[
\text{caffeine_mg} = \frac{\text{Day 1 caffeine} + \text{Day 2 caffeine}}{2}
\]


Data was drawn from NHANES's total nutrient intake files (DR1TOT / DR2TOT) including:

- `DR1TCAFF` – total caffeine intake on Day 1 (mg)
- `DR2TCAFF` – total caffeine intake on Day 2 (mg)


### Data Cleaning: Part One

All data processing was conducted in **RStudio** using **R Markdown** and tidyverse tools.

In the first cleaning stage, we:

1. **Imported and standardized datasets**

   - NHANES `.XPT` files were read using `haven::read_xpt()`.
   - Variable names were converted to snake_case using `janitor::clean_names()` for consistency.
   - key data files are renamed for clarity.
   - Key laboratory variables were renamed for clarity, for example:
     - `lbxtc` → `total_cholesterol`
     - `lbdhdd` → `hdl`
     - `lbdldlm` → `ldl`
     - `lbxgh` → `glycohemoglobin`
     - `lbxglu` → `glucose_mgdl`
     - `lbxin` → `insulin_uuml`

2. **Merged NHANES modules**

   - Demographic, laboratory, and examination datasets were merged by `seqn`, ending up with a combined dataset `analytic.csv`.

3. **Constructed coffee habit variables**

   - Using USDA food codes, we flagged all coffee-containing items on each recall day.
   - Participants were classified based on consumption across both dietary recall days. 
   - We then created `coffee_habit_binary` and `coffee_habit` as defined above.

4. **Remove missing values and age filtering**
  - Participants missing any of the necessary biomarkers (blood pressure, pulse, sleep, diabetes, CVD) were excluded. 
  - Participants who drank coffee on only one of the two recall days were excluded due to inconsistency in coffee habit. 
  - To focus on adult participants and avoid extremes, we restricted analyses to:

\[
20 \leq \text{age} \leq 70
\]

This age subset is used in all biomarker analyses.

The result of Part One was a wide analytic dataset containing merged dietary and biomarker data, along with an initial classification of coffee consumption.

---

### Data Cleaning: Part Two

The second cleaning stage focused on preparing an analysis-ready data/variables for our health outcomes.

Key steps included:

1. **Ensuring valid and complete biomarker data**

   - Continuous biomarker variables (glucose, glycohemoglobin, insulin, HDL, LDL, total cholesterol) were checked for non-numeric entries and converted to numeric where necessary.
   - Participants with missing values for any biomarker used in a given analysis were excluded to create complete-case subsets.

2. **Recoding and factor creation**

   - `coffee_habit` was encoded as a factor with levels ordered as `No`, `Yes`.

3. **Creating tidy long-format datasets for plotting**

   - For cardiovascular biomarkers, we constructed a long-format dataset `cvd_long` with variables:
     - `coffee_habit`
     - `biomarker` (HDL, LDL, Total Cholesterol)
     - `value` (mg/dL)
   - For diabetes biomarkers, we created `diabetes_long` with:
     - `coffee_habit`
     - `biomarker` (glucose, glycohemoglobin, insulin)
     - `value`
4. **Creating analysis-ready variable for regression**
- `caffeine_mg` is computed and used in linear regression models
- This variable captures **dose** rather than binary consumption

These tidy datasets were used to generate violin/boxplots and to run group-wise t-tests.
   
---

### Summary of Variables Used

#### **Exposure Variables**
- `coffee_habit_binary` (TRUE/FALSE): whether the individual have coffee drinking habit
- `coffee_habit` ("No", "Yes")
- `caffeine_mg` (continuous caffeine intake): the average daily caffeine intake (mg) by the individual

#### **Blood Pressure Biomarkers**

#### **Sleep Biomarkers**

#### **Diabetes Biomarkers**
- `glycohemoglobin`: Glycohemoglobin (%) 
- `glucose_mgdl`: Fasting Glucose (mg/dL)
- `insulin_uuml`: Insulin (µU/mL)

#### **CVD Biomarkers**
- `hdl`: Direct HDL-Cholesterol (mg/dL)
- `ldl`: LDL-Cholesterol, Martin-Hopkins measurement (mg/dL)
- `total_cholesterol`: Total Cholesterol (mg/dL)

#### **Demographics**
- `seqn`: Respondent sequence number
- `ridageyr`: Age in years at screening

---
### Notes
- All analyses (plots, t-tests, regressions) use **subsets taken from analytic.csv**, not raw NHANES files.  
- The master dataset contains **all participants, all examination/nutrient/lab variables**, and is filtered only at the step of constructing domain-specific datasets.  
- This design ensures reproducibility and avoids repeated merging of NHANES modules.



## Exploratory Data Analysis
We selected data from August 21 to August 23 in the NHANES database, identifying individuals who consumed coffee in both random tests as having a coffee-drinking habit and assigning them to the experimental group. Those who did not consume coffee beverages in either test were classified as having no coffee-drinking habit and assigned to the control group. We visualized questionnaire results and biomarkers for both groups and conducted hypothesis testing.

### Group Comparisons: Coffee Intake vs No Coffe Intake

#### Blood Pressure & Pulse

```{r include = FALSE}
bp_sleep_df <- analytic |>
  mutate(
    coffee_group = factor(
      coffee_habit_binary,
      levels = c(0, 1),
      labels = c("No coffee", "Coffee habit")
    ), 

    # Pressure
    sbp = rowMeans(across(c(bpxosy1, bpxosy2, bpxosy3)), na.rm = TRUE),
    dbp = rowMeans(across(c(bpxodi1, bpxodi2, bpxodi3)), na.rm = TRUE),

    # Pulse
    pulse = rowMeans(across(c(bpxopls1, bpxopls2, bpxopls3)), na.rm = TRUE),

    # Sleep
    sleep_weekday = sld012,
    sleep_weekend = sld013,
    sleep_avg = (sleep_weekday * 5 + sleep_weekend * 2) / 7
  ) |> 
   filter(!is.na(coffee_group))

```

- Plot: Blood pressure by coffee habit
```{r echo = TRUE}
bp_long <- bp_sleep_df |>
  select(seqn, coffee_group, sbp, dbp) |>
  pivot_longer(cols = c(sbp, dbp),
               names_to = "bp_type",
               values_to = "bp_value") |>
  mutate(
    bp_type = factor(
      bp_type,
      levels = c("sbp", "dbp"),
      labels = c("Systolic BP", "Diastolic BP")
    )
  )

gg_bp_violin <- ggplot(bp_long,
                       aes(x = coffee_group,
                           y = bp_value,
                           fill = coffee_group)) +
  geom_violin(alpha = 0.4, trim = FALSE) +
  geom_boxplot(width = 0.18, outlier.size = 0.5) +
  facet_wrap(~ bp_type, scales = "free_y") +
  labs(x = NULL, y = "Blood pressure (mmHg)",
       title = "Blood pressure by coffee habit") +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none", 
        plot.title = element_text(hjust = 0.5))
gg_bp_violin
```

The distributions of systolic and diastolic blood pressure among groups that consumed coffee are shown in this figure. Violin shapes show the whole density and range of values, and integrated boxplots make it easy to compare medians and interquartile ranges. There are just little changes between the groups; for example, those who regularly drink coffee had somewhat higher systolic readings. It seems that missingness is not systematic, as the NA group exhibits behavior that is consistent with the other categories. Potential, however modest, correlations between blood pressure and regular coffee use are efficiently brought to light by this depiction.

- Plot: Mean Systolic & Diastolic BP (with 95% CI) by coffee habit

```{r echo = TRUE}
bp_summary <- bp_sleep_df |>
  group_by(coffee_group) |>
  summarise(
    mean_sbp = mean(sbp, na.rm = TRUE),
    se_sbp   = sd(sbp, na.rm = TRUE) / sqrt(sum(!is.na(sbp))),
    mean_dbp = mean(dbp, na.rm = TRUE),
    se_dbp   = sd(dbp, na.rm = TRUE) / sqrt(sum(!is.na(dbp)))
  ) |>
  pivot_longer(
    cols = -coffee_group,
    names_to = c("metric", "bp_type"),
    names_sep = "_"
  ) |>
  pivot_wider(
    names_from = metric,
    values_from = value
  ) |>
  mutate(
    bp_type = factor(
      bp_type,
      levels = c("sbp", "dbp"),
      labels = c("Systolic BP", "Diastolic BP")
    )
  )

gg_bp_mean_line <- 
  ggplot(bp_summary, aes(x = coffee_group, y = mean, color = bp_type, group = bp_type)) +
  geom_point(size = 3) +
  geom_line(linewidth = 1) +
  geom_errorbar(aes(ymin = mean - 1.96 * se, ymax = mean + 1.96 * se), width = 0.1) +
  labs(x = NULL, y = "Mean BP (mmHg)",
       color = NULL,
       title = "Mean Systolic & Diastolic BP by coffee habit") +
  theme_minimal(base_size = 13) + 
  theme(plot.title = element_text(hjust = 0.5))
gg_bp_mean_line
```

Displayed here with 95% confidence intervals are the mean diastolic and systolic blood pressure readings for the whole cohort. The group that regularly drinks coffee had somewhat higher systolic blood pressure than the group that does not, but there is no change in diastolic blood pressure. Since the confidence intervals for different groups overlap, it's possible that the observed changes in means may not reflect significant impacts. In addition to the distributions given for individuals, this graphic gives a clear picture of the population as a whole.

- Plot: Pulse distribution by coffee habit

```{r echo = TRUE}
gg_pulse_ridge <- 
  ggplot(bp_sleep_df, aes(x = pulse, y = coffee_group, fill = coffee_group)) +
  geom_density_ridges(alpha = 0.5, scale = 1.1) +
  labs(x = "Pulse (beats/min)", y = NULL,
       title = "Pulse distribution by coffee habit") +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none", 
        plot.title = element_text(hjust = 0.5))
gg_pulse_ridge
```

The ridgeline density plot visualizes pulse-rate distributions across coffee habits. While the overall shapes are similar, the coffee-habit group appears to trend slightly higher in pulse rate, though the overlap between groups is substantial. This plot effectively demonstrates distributional differences without relying on summary statistics and provides an intuitive sense of how pulse varies across the cohort.

#### Sleep Status

- Plot: Average sleep time by coffee habit

```{r echo = TRUE}
gg_sleep_violin <- 
  ggplot(bp_sleep_df, aes(x = coffee_group, y = sleep_avg, fill = coffee_group)) +
  geom_violin(alpha = 0.4, trim = FALSE) +
  geom_boxplot(width = 0.18, outlier.size = 0.5) +
  labs(x = NULL, y = "Average sleep duration (hours)",
       title = "Average sleep time by coffee habit") +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none", 
        plot.title = element_text(hjust = 0.5))
gg_sleep_violin
```

This visualization shows the distribution of average daily sleep time across coffee-consumption categories. The central tendencies differ only slightly, with coffee-habit individuals sleeping marginally less on average. The overall shape and spread are similar across categories, suggesting that habitual coffee intake is not strongly related to average sleep duration. The combination of violin and boxplot elements provides both distributional context and robust summary measures.

- Plot: Weekday vs weekend sleep by coffee habit

```{r echo = TRUE}
sleep_long <- bp_sleep_df |>
  select(seqn, coffee_group, sleep_weekday, sleep_weekend) |>
  pivot_longer(
    cols = c(sleep_weekday, sleep_weekend),
    names_to = "day_type",
    values_to = "sleep_hours"
  ) |>
  mutate(
    day_type = factor(
      day_type,
      levels = c("sleep_weekday", "sleep_weekend"),
      labels = c("Weekday", "Weekend")
    )
  )

gg_sleep_paired <- 
  ggplot(sleep_long, aes(x = day_type, y = sleep_hours, group = seqn)) +
  geom_line(alpha = 0.12) + 
  stat_summary(fun = mean, geom = "line", aes(group = 1), linewidth = 1.2, color = "black") +
  stat_summary(fun = mean, geom = "point", size = 3, color = "black") +
  facet_wrap(~ coffee_group) +
  labs(x = NULL, y = "Sleep duration (hours)",
       title = "Weekday vs weekend sleep by coffee habit") +
  theme_minimal(base_size = 13) + 
  theme(plot.title = element_text(hjust = 0.5))
gg_sleep_paired
```

Individual differences in sleep duration on weekdays and weekends are shown by this paired-line plot. People in every coffee group get more shut-eye on weekends, and the size of the difference between weekday and weekend sleep is about the same. Individual variability is shown by the dense cluster of light gray lines, while the group-average pattern is captured by the overlay black summary line. This graph shows that the difference in sleep between the weekdays and weekends is unaffected by coffee use.

#### Diabetes Risk

```{r}
# clean and tidy data
diabetes_df = analytic |>
  rename(
    glycohemoglobin = lbxgh, 
    insulin_uuml = lbxin, 
    glucose_mgdl = lbxglu
  ) |>
  select(
    seqn, 
    coffee_habit_binary, 
    glycohemoglobin, 
    insulin_uuml, 
    glucose_mgdl
  ) |>
  filter(
    !is.na(glycohemoglobin), 
    !is.na(insulin_uuml), 
    !is.na(glucose_mgdl)
  )
```

- Plot: Diabetes biomarker level by coffee habit

```{r bar_chart}
diabetes_long <- diabetes_df |>
  filter(!is.na(coffee_habit_binary)) |>
  mutate(
    coffee_habit = if_else(coffee_habit_binary, "Yes", "No"),
coffee_habit = factor(coffee_habit, levels = c("No", "Yes"))
  ) |>
  select(coffee_habit, glycohemoglobin, insulin_uuml, glucose_mgdl) |>
  pivot_longer(
    cols = c(glycohemoglobin, insulin_uuml, glucose_mgdl),
    names_to = "biomarker",
    values_to = "value"
  ) |>
  mutate(
    biomarker = factor(
      biomarker, 
      levels = c("glycohemoglobin", "insulin_uuml", "glucose_mgdl"), 
      labels = c("Glycohemoglobin (%)", "Insulin (μU/mL)", "Glucose (mg/dL)")
    ))

summary_df <- diabetes_long |>
  group_by(coffee_habit, biomarker) |>
  summarize(
    mean_value = mean(value, na.rm = TRUE),
    se = sd(value, na.rm = TRUE) / sqrt(sum(!is.na(value))),
    n = sum(!is.na(value)),
    .groups = "drop")
p <- ggplot(summary_df,
            aes(x = coffee_habit, y = mean_value, fill = coffee_habit)) +
  geom_col(width = 0.6) +
  geom_errorbar(aes(ymin = mean_value - 1.96 * se,
                    ymax = mean_value + 1.96 * se),
                width = 0.15) +
  facet_wrap(~ biomarker, scales = "free_y") +
  labs(
    title = "Diabetes biomarker level by coffee habit", 
    x = "Coffee habit",
    y = "Mean diabetes biomarker level",
    fill = "Coffee habit"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 20, hjust = 1), 
    plot.title = element_text(hjust = 0.5)
  )
ggplotly(p)
```

#### Two-sample t-test
Outcome/biomarkers: 

- Glycohemoglobin (%)

- Insulin (μU/mL)

- Glucose (mg/dL)

H_0: mean biomarker is the same in coffee vs. no-coffee
H_1: mean biomarkers is different between the two groups
```{r t_test}
# run two-sample t-tests by biomarker
ttest_results = diabetes_long |>
  group_by(biomarker) |>
  group_modify(~ broom::tidy(t.test(value ~ coffee_habit, data = .x))) |>
  ungroup()

# clean up column names
ttest_results_clean = ttest_results |>
  transmute(
    biomarker,
    mean_no = estimate1,
    mean_yes = estimate2,
    diff_mean = estimate2 - estimate1,
    ci_low = -conf.high,
    ci_high = -conf.low,
    p_value = p.value
  )

# tidy the test result
ttest_results_clean |>
  mutate(
    across(
      c(mean_no, mean_yes, diff_mean, ci_low, ci_high),
      ~ round(.x, 2)
    ),
    p_value = signif(p_value, 3)
  ) |>
  knitr::kable(
    caption = "Difference in mean diabetes biomarkers between coffee habit groups"
  )
```

Among participants with complete diabetes biomarker data (N = `r nrow(diabetes_df)`), we compared
glycohemoglobin, fasting glucose, and insulin levels between those who drank coffee on both recall days (with coffee habit)
and those who did not drink coffee (without coffee habit).

#### Results: Diabetes Biomarkers and Coffee Consumption

We compared fasting glucose, glycohemoglobin (HbA1c), and fasting insulin between adults who did not drink coffee (“No”) and those who drank coffee on both days (“Yes”).

**Fasting glucose:**  
The mean fasting glucose level was `r round(ttest_results_clean$mean_no[ttest_results_clean$biomarker=="Glucose (mg/dL)"], 2)` mg/dL in the no_coffee group and `r round(ttest_results_clean$mean_yes[ttest_results_clean$biomarker=="Glucose (mg/dL)"], 2)` mg/dL in the coffee group.  
The mean difference (Yes − No) was  **`r round(ttest_results_clean$diff_mean[ttest_results_clean$biomarker=="Glucose (mg/dL)"], 2)` mg/dL** with a 95% CI of  (`r round(ttest_results_clean$ci_low[ttest_results_clean$biomarker=="Glucose (mg/dL)"], 2)`, `r round(ttest_results_clean$ci_high[ttest_results_clean$biomarker=="Glucose (mg/dL)"], 2)`)  and a p-value of `r signif(ttest_results_clean$p_value[ttest_results_clean$biomarker=="Glucose (mg/dL)"], 3)`.  
This indicates no statistically significant in fasting glucose among coffee drinkers. Fails to reject the null hypothesis.

**Glycohemoglobin (HbA1c):**  
HbA1c averaged `r round(ttest_results_clean$mean_no[ttest_results_clean$biomarker=="Glycohemoglobin (%)"], 2)`% in the No group and  `r round(ttest_results_clean$mean_yes[ttest_results_clean$biomarker=="Glycohemoglobin (%)"], 2)`% in the Yes group.  
The mean difference was **`r round(ttest_results_clean$diff_mean[ttest_results_clean$biomarker=="Glycohemoglobin (%)"], 2)`%**  (95% CI:  `r round(ttest_results_clean$ci_low[ttest_results_clean$biomarker=="Glycohemoglobin (%)"], 2)`,  `r round(ttest_results_clean$ci_high[ttest_results_clean$biomarker=="Glycohemoglobin (%)"], 2)`)  with a p-value of `r signif(ttest_results_clean$p_value[ttest_results_clean$biomarker=="Glycohemoglobin (%)"], 3)`.  
Large p-value suggests no statistically significant difference in HbA1c between coffee and non-coffee drinkers. Fails to reject the null hypothesis.

**Fasting insulin:**  
The mean insulin level was  `r round(ttest_results_clean$mean_no[ttest_results_clean$biomarker=="Insulin (μU/mL)"], 2)` μU/mL in the No group and `r round(ttest_results_clean$mean_yes[ttest_results_clean$biomarker=="Insulin (μU/mL)"], 2)` μU/mL in the Yes group.  
The mean difference (Yes − No) was  **`r round(ttest_results_clean$diff_mean[ttest_results_clean$biomarker=="Insulin (μU/mL)"], 2)` μU/mL**  with a 95% CI of (`r round(ttest_results_clean$ci_low[ttest_results_clean$biomarker=="Insulin (μU/mL)"], 2)`, `r round(ttest_results_clean$ci_high[ttest_results_clean$biomarker=="Insulin (μU/mL)"], 2)`)  and a p-value of `r signif(ttest_results_clean$p_value[ttest_results_clean$biomarker=="Insulin (μU/mL)"], 3)`.  
This reflects a statistically significant decrease in fasting insulin among coffee drinkers.

#### Cardiovascular Disease Risk

```{r tidy_cvd_data}
cvd_df = analytic |>
  rename(
    total_cholesterol = lbxtc, # unit = mg/dl
    hdl = lbdhdd, # good cholesterol, unit = mg/dl
    ldl = lbdldlm # bad cholesterol, unit = mg/dl (Martin-Hopkins)
  ) |>
  select(
    seqn, 
    coffee_habit_binary, 
    hdl, 
    ldl, 
    total_cholesterol
  ) |>
  filter(
    !is.na(hdl), 
    !is.na(ldl), 
    !is.na(total_cholesterol)
  )
```

- Plot: CVD biomarker level by coffee habit

```{r cvd_plot}
# make a tidy long dataset for plotting
cvd_long = cvd_df |>
  filter(!is.na(coffee_habit_binary)) |>
  mutate(
    coffee_habit = if_else(coffee_habit_binary, "Yes", "No"),
coffee_habit = factor(coffee_habit, levels = c("No", "Yes"))
  ) |>
  pivot_longer(
    cols = c(hdl, ldl, total_cholesterol),
    names_to = "biomarker",
    values_to = "value"
  ) |>
  mutate(
    biomarker = factor(
      biomarker, 
      levels = c("hdl", "ldl", "total_cholesterol"), 
      labels = c("HDL", "LDL", "Total Cholesterol")
    )
  )

# ggplot: violin + boxplot, faceted by biomarker
p = ggplot(cvd_long, aes(x = coffee_habit, y = value, fill = coffee_habit)) +
  geom_violin(trim = FALSE, alpha = 0.6) +
  geom_boxplot(width = 0.15, outlier.alpha = 0.3) +
  facet_wrap(~ biomarker, scales = "free_y") +
  labs(
    x = "Coffee habit",
    y = "Biomarker level (mg/dL)",
    title = "CVD biomarker level by coffee habit"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 20, hjust = 1), 
    plot.title = element_text(hjust = 0.5)
  )

# turn into interactive plot
p_interactive = ggplotly(p)
p_interactive
```

#### Two-sample t-test
```{r t-test}
cvd_ttest_raw = cvd_long |>
  group_by(biomarker) |>
  group_modify(~ broom::tidy(t.test(value ~ coffee_habit_binary, data = .x))) |>
  ungroup()

# clean results: convert direction to (yes-no), flip CI accordingly
cvd_ttest_clean = cvd_ttest_raw |>
  transmute(
    biomarker, 
    mean_no = estimate1, 
    mean_yes = estimate2, 
    diff_mean = estimate2 - estimate1, 
    ci_low = -conf.high, 
    ci_high = -conf.low, 
    p_value = p.value
  )

knitr::kable(cvd_ttest_clean)
```

Based on the two-sample t-tests, HDL (good cholesterol) levels were higher among coffee drinkers with a statistically significant difference (mean difference = `r round(cvd_ttest_clean$diff_mean[cvd_ttest_clean$biomarker == "HDL"], 2)` mg/dL, 95% CI: `r paste0("(", round(cvd_ttest_clean$ci_low[cvd_ttest_clean$biomarker == "HDL"], 2),", ", round(cvd_ttest_clean$ci_high[cvd_ttest_clean$biomarker == "HDL"], 2), ")")`, *p* = `r signif(cvd_ttest_clean$p_value[cvd_ttest_clean$biomarker == "HDL"], 3)`).

For LDL (bad cholesterol), the mean difference was `r round(cvd_ttest_clean$diff_mean[cvd_ttest_clean$biomarker == "LDL"], 2)` mg/dL (95% CI: `r paste0("(", round(cvd_ttest_clean$ci_low[cvd_ttest_clean$biomarker == "LDL"], 2), ", ", round(cvd_ttest_clean$ci_high[cvd_ttest_clean$biomarker == "LDL"], 2), ")")`), with *p* = `r signif(cvd_ttest_clean$p_value[cvd_ttest_clean$biomarker == "LDL"], 3)`, 
indicating that the difference was not statistically significant.

Total cholesterol was also significantly higher among coffee drinkers (mean difference = `r round(cvd_ttest_clean$diff_mean[cvd_ttest_clean$biomarker == "Total Cholesterol"], 2)` mg/dL, 95% CI: `r paste0("(", round(cvd_ttest_clean$ci_low[cvd_ttest_clean$biomarker == "Total Cholesterol"], 2), ", ", round(cvd_ttest_clean$ci_high[cvd_ttest_clean$biomarker == "Total Cholesterol"], 2), ")")`, *p* = `r signif(cvd_ttest_clean$p_value[cvd_ttest_clean$biomarker == "Total Cholesterol"], 3)`).




## Regression Analysis

### Blood Pressure & Pulse

```{r}
bp_sleep_rg <- analytic |>
  mutate(
    coffee_group = factor(
      coffee_habit_binary,
      levels = c(0, 1),
      labels = c("No coffee", "Coffee habit")
    ), 

    # Pressure
    sbp = rowMeans(across(c(bpxosy1, bpxosy2, bpxosy3)), na.rm = TRUE),
    dbp = rowMeans(across(c(bpxodi1, bpxodi2, bpxodi3)), na.rm = TRUE),

    # Pulse
    pulse = rowMeans(across(c(bpxopls1, bpxopls2, bpxopls3)), na.rm = TRUE),

    # Sleep
    sleep_weekday = sld012,
    sleep_weekend = sld013,
    sleep_avg = (sleep_weekday * 5 + sleep_weekend * 2) / 7,
    caffeine_mg = (dr1tcaff + dr2tcaff) / 2
  ) |> 
   filter(!is.na(coffee_group))
```

- Blood pressure regression model

```{r}
bp_rg = bp_sleep_rg %>% 
  select(seqn, coffee_group, sbp, dbp, caffeine_mg)

model_sbp = lm(sbp ~ caffeine_mg, data = bp_rg)
model_dbp = lm(dbp ~ caffeine_mg, data = bp_rg)

summary(model_sbp)
summary(model_dbp)
```

- Blood pressure regression plot

```{r}
bp_rg_long = bp_rg %>% 
  pivot_longer(cols = c(sbp, dbp),
               names_to = "bp_type",
               values_to = "bp_value") %>% 
  filter(coffee_group == "Coffee habit")

bp_rg_plot = bp_rg_long %>% 
  ggplot(aes(x = caffeine_mg, 
             y = bp_value, 
             color = bp_type)) + 
  geom_point(size = 0.8, 
             alpha = 0.4) + 
  geom_smooth(method = "lm", 
              se = TRUE, 
              size = 0.8) + 
  labs(x = "Caffeine intake (mg)", 
       y = "Blood pressure (mmHg)", 
       title = "Blood pressure vs caffeine intake") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_color_discrete(name = "BP type")

bp_rg_interactive = ggplotly(bp_rg_plot)
bp_rg_interactive$x$data[[1]]$name <- "Diastolic BP"
bp_rg_interactive$x$data[[2]]$name <- "Systolic BP"
bp_rg_interactive
```

Simple linear regressions of systolic and diastolic blood pressure on daily caffeine intake showed only very weak positive slopes (≈0.31 mmHg and 0.06 mmHg higher per 100 mg of caffeine, respectively), with non-significant p-values and R² ≈ 0. Scatterplots confirmed that blood pressure varies widely at all intake levels and that fitted lines are almost flat. Overall, within the range of usual consumption in NHANES, caffeine intake appears at most minimally associated with higher SBP and essentially unrelated to DBP, and any true effect is likely small relative to other determinants of blood pressure.


### Sleep Status

- Sleep regression model 

```{r}
sleep_rg = bp_sleep_rg %>% 
  select(seqn, coffee_group, sleep_avg, caffeine_mg)

model_sleep = lm(sleep_avg ~ caffeine_mg, data = sleep_rg)

summary(model_sleep)
```

- Sleep regression plot

```{r}
sleep_rg_time = sleep_rg %>% 
  filter(coffee_group == "Coffee habit") %>%
  ggplot(aes(x = caffeine_mg, 
             y = sleep_avg)) + 
  geom_point(size = 0.8, 
             alpha = 0.4, 
             color = "gray30") + 
  geom_smooth(method = "lm", 
              size = 0.8) + 
  labs(x = "Caffeine intake (mg)", 
       y = "Average sleep duration (hours)", 
       title = "Average sleep time vs caffeine intake") + 
  theme(plot.title = element_text(hjust = 0.5)) 

sleep_rg_interactive = ggplotly(sleep_rg_time)
sleep_rg_interactive
```

Regressing average nightly sleep time on caffeine intake suggested a slight negative trend (about 1–2 minutes less sleep per 100 mg of caffeine), but this association was not statistically significant and again explained virtually none of the variation in sleep time (R² ≈ 0.0006). The scatterplot showed most participants sleeping 7–8 hours regardless of intake, with only a subtle downward tilt in the regression line. These findings indicate that habitual caffeine use may be linked to marginally shorter sleep, but the effect is very small and easily overshadowed by factors such as work schedules and overall lifestyle.


### Diabetes Risk

```{r}
# Data tidying
analytic = read_csv("./analytic.csv")

diabetes_rg = analytic |>
  rename(
    glycohemoglobin = lbxgh, 
    insulin_uuml = lbxin, 
    glucose_mgdl = lbxglu
  ) |>
  mutate(caffeine_mg = (dr1tcaff + dr2tcaff) / 2) %>% 
  select(
    seqn, 
    coffee_habit_binary, 
    glycohemoglobin, 
    insulin_uuml, 
    glucose_mgdl, 
    caffeine_mg
  ) |>
  dplyr::filter(
    !is.na(glycohemoglobin), 
    !is.na(insulin_uuml), 
    !is.na(glucose_mgdl), 
    coffee_habit_binary == "TRUE"
  )
```

- Diabetes regression model

```{r}
model_glyco = lm(glycohemoglobin ~ caffeine_mg, data = diabetes_rg)
model_insulin = lm(insulin_uuml ~ caffeine_mg, data = diabetes_rg)
model_glucose = lm(glucose_mgdl ~ caffeine_mg, data = diabetes_rg)

summary(model_glyco)
summary(model_insulin)
summary(model_glucose)
```

- Diabetes regression plot

```{r}
glyco_rg = ggplot(diabetes_rg, aes(x = caffeine_mg, y = glycohemoglobin)) +
  geom_point(size = .8, alpha = .5, color = "gray30") +
  geom_smooth(method = "lm", se = TRUE, size = .8) +
  labs(title = "Diabetes biomarkers vs caffeine intake", x = " ", y = "Biomarker level") + 
  theme(plot.title = element_text(hjust = .5))

insulin_rg = ggplot(diabetes_rg, aes(x = caffeine_mg, y = insulin_uuml)) +
  geom_point(size = .8, alpha = .5, color = "gray30") +
  geom_smooth(method = "lm", se = TRUE, size = .8) +
  labs(x = "Caffeine (mg)", y = " ") 

glucose_rg = ggplot(diabetes_rg, aes(x = caffeine_mg, y = glucose_mgdl)) +
  geom_point(size = .8, alpha = .5, color = "gray30") +
  geom_smooth(method = "lm", se = TRUE, size = .8) +
  labs(x = " ", y = " ")

diabetes_rg_interactive = subplot(
  ggplotly(glyco_rg, tooltip = "all"),
  ggplotly(insulin_rg, tooltip = "all"),
  ggplotly(glucose_rg, tooltip = "all"),
  nrows = 1, 
  titleX = TRUE, 
  titleY = TRUE, 
  margin = 0.05) %>% 
  layout(
    annotations = list(
      list(
        x = 0.16, y = 1.07,
        text = "<b>Glycohemoglobin (%)</b>",
        xref = "paper", yref = "paper",
        xanchor = "center", showarrow = FALSE,
        font = list(size = 12)
      ),
      list(
        x = 0.5, y = 1.07,
        text = "<b>Insulin (μU/mL)</b>",
        xref = "paper", yref = "paper",
        xanchor = "center", showarrow = FALSE,
        font = list(size = 12)
      ),
      list(
        x = 0.84, y = 1.07,
        text = "<b>Glucose (mg/dL)</b>",
        xref = "paper", yref = "paper",
        xanchor = "center", showarrow = FALSE,
        font = list(size = 12)
      )
    ),
    margin = list(t = 80), 
    showlegend = FALSE
  ) 

diabetes_rg_interactive
```

For diabetes biomarkers, regressions of HbA1c, fasting glucose, and fasting insulin on caffeine intake yielded small, non-significant slopes, with HbA1c and glucose showing slightly negative trends and insulin showing the clearest negative association (≈0.37 μU/mL lower insulin per 100 mg of caffeine). Individuals with very high insulin levels were concentrated at low or zero caffeine intake, and higher-intake participants tended to have lower insulin. Although R² values were near zero, these patterns are compatible with the hypothesis that higher caffeine intake is not associated with worse glycemic control and may be related to slightly lower insulin requirements, suggesting possible improvement in insulin sensitivity that warrants further, adjusted analyses.


### Cardiovascular Disease Risk

```{r}
# Data tidying
cvd_rg = analytic |>
  rename(
    total_cholesterol = lbxtc, # unit = mg/dl
    hdl = lbdhdd, # good cholesterol, unit = mg/dl
    ldl = lbdldlm # bad cholesterol, unit = mg/dl (Martin-Hopkins)
  ) |>
  mutate(caffeine_mg = (dr1tcaff + dr2tcaff) / 2) %>% 
  select(
    seqn, 
    coffee_habit_binary, 
    hdl, 
    ldl, 
    total_cholesterol,
    caffeine_mg
  ) |>
  filter(
    !is.na(hdl), 
    !is.na(ldl), 
    !is.na(total_cholesterol), 
    coffee_habit_binary == "TRUE"
  )
```

- CVD regression model

```{r}

model_chlesterol = lm(total_cholesterol ~ caffeine_mg, data = cvd_rg)
model_hdl = lm(hdl ~ caffeine_mg, data = cvd_rg)
model_ldl = lm(ldl ~ caffeine_mg, data = cvd_rg)

summary(model_chlesterol)
summary(model_hdl)
summary(model_ldl)
```

- CVD regression plot

```{r}
# Visuallizatoin
chlesterol_rg = ggplot(cvd_rg, aes(x = caffeine_mg, y = total_cholesterol)) +
  geom_point(size = .8, alpha = .5, color = "gray30") +
  geom_smooth(method = "lm", se = TRUE, size = .8) +
  labs(title = "CVD biomarkers vs caffeine intake", x = " ", y = "Biomarker level (mg/dL)") + 
  theme(plot.title = element_text(hjust = .5))

hdl_rg = ggplot(cvd_rg, aes(x = caffeine_mg, y = hdl)) +
  geom_point(size = .8, alpha = .5, color = "gray30") +
  geom_smooth(method = "lm", se = TRUE, size = .8) +
  labs(x = "Caffeine (mg)", y = " ")

ldl_rg = ggplot(cvd_rg, aes(x = caffeine_mg, y = ldl)) +
  geom_point(size = .8, alpha = .5, color = "gray30") +
  geom_smooth(method = "lm", se = TRUE, size = .8) +
  labs(x = " ", y = " ") 

cvd_rg_interactive = subplot(
  ggplotly(chlesterol_rg, tooltip = "all"),
  ggplotly(hdl_rg, tooltip = "all"),
  ggplotly(ldl_rg, tooltip = "all"),
  nrows = 1, 
  titleX = TRUE, 
  titleY = TRUE, 
  margin = 0.05) %>% 
  layout(
    annotations = list(
      list(
        x = 0.16, y = 1.07,
        text = "<b>Total Chlesterol</b>",
        xref = "paper", yref = "paper",
        xanchor = "center", showarrow = FALSE,
        font = list(size = 12)
      ),
      list(
        x = 0.5, y = 1.07,
        text = "<b>HDL</b>",
        xref = "paper", yref = "paper",
        xanchor = "center", showarrow = FALSE,
        font = list(size = 12)
      ),
      list(
        x = 0.84, y = 1.07,
        text = "<b>LDL</b>",
        xref = "paper", yref = "paper",
        xanchor = "center", showarrow = FALSE,
        font = list(size = 12)
      )
    ),
    margin = list(t = 80), 
    showlegend = FALSE
  ) 

cvd_rg_interactive
```

Linear models relating caffeine intake to total cholesterol, LDL, and HDL showed weak, imprecise associations: small positive slopes for total cholesterol and LDL and a small negative slope for HDL, all with non-significant p-values and R² ≈ 0. Scatterplots revealed broad variability in lipid levels at all intake levels and nearly flat fitted lines, though the directions of the slopes were generally consistent with the group comparisons between coffee drinkers and non-drinkers. Overall, within typical intake ranges, any dose–response relationship between caffeine and lipid biomarkers appears subtle and easily masked by diet, adiposity, medications, and other CVD risk factors, so these results are best viewed as descriptive and hypothesis-generating.


## Conclusion

### Discussion
Using recent NHANES cycles, we compared adults with and without a consistent coffee-drinking habit and then examined continuous caffeine intake in relation to cardiometabolic and sleep-related biomarkers. Overall, our findings suggest that habitual coffee consumption is not strongly associated with major adverse profiles in blood pressure, lipids, glycemic markers, or sleep duration, although several small and potentially meaningful patterns emerged.

For diabetes outcomes, coffee drinkers had slightly higher fasting glucose and HbA1c but notably lower fasting insulin compared with non-drinkers. In the regression analyses, caffeine dose showed almost flat relationships with HbA1c and glucose but a modest negative trend with insulin. This combination—similar glucose at somewhat lower insulin levels—is compatible with slightly better insulin sensitivity among higher-caffeine consumers, which is broadly consistent with prior literature suggesting a protective association between habitual coffee intake and type 2 diabetes risk. However, the absolute differences were small and the models had very low R², so these patterns should be interpreted as suggestive rather than causal.

For cardiovascular markers, coffee drinkers had higher HDL alongside modestly higher LDL and total cholesterol, and regression slopes for caffeine intake were weak and imprecise. Blood pressure and pulse showed a similar picture: coffee drinkers and non-drinkers had broadly overlapping distributions, and caffeine intake was at most very weakly related to higher systolic blood pressure and slightly faster pulse. Sleep duration was also remarkably similar across coffee-habit groups; higher caffeine intake was only minimally associated with shorter average sleep. Together, these results point toward a largely neutral overall cardiometabolic profile for coffee drinkers, rather than strongly harmful or strongly beneficial effects.

These findings are partly in line with what we expected based on prior studies: we saw no evidence that higher caffeine intake is dramatically harmful, and some patterns (lower insulin with comparable glucose, higher HDL) are consistent with potential metabolic benefits of coffee. At the same time, the weak dose–response relationships and tiny R² values highlight that, in this cross-sectional setting, caffeine explains very little of the large person-to-person variability in these biomarkers. Our analysis is limited by self-reported diet, a two-day definition of “coffee habit,” lack of adjustment for key confounders (age, BMI, smoking, diet quality, medications, socioeconomic factors), and the cross-sectional design, which prevents causal inference.

An important insight from this project is that categorizing people as “coffee habit” vs “no coffee” captures broader lifestyle patterns, while continuous caffeine intake alone is a poor predictor of biomarker levels. Future work should incorporate multivariable models, explore non-linear dose–response relationships, separate coffee from other caffeinated beverages and added sugar/cream, and, ideally, use longitudinal data to study incident disease. Within the limits of our analysis, the data suggest that typical coffee consumption in U.S. adults is unlikely to have large detrimental effects on blood pressure, lipids, sleep, or glycemic control, and may be compatible with slightly improved insulin sensitivity.

### Limitation
This study has several important limitations. First, our definition of “coffee habit” is based on two 24-hour dietary recalls: participants who reported coffee on both days were treated as habitual drinkers, and those who reported none were treated as non-drinkers. This approach may misclassify long-term coffee habits, because two days may capture short-term intake and day-to-day variation rather than stable behavior. As a result, estimated associations may reflect acute responses or random fluctuation more than true long-term effects.

Second, our analyses are cross-sectional and largely unadjusted. We did not control for many important confounders such as socioeconomic status, smoking, alcohol use, diet quality, physical activity, psychological stress, medication use, or pre-existing diseases. All of these factors are strongly related to both coffee consumption and cardiometabolic health and could easily explain part or all of the observed patterns. Self-reported diet and sleep also introduce measurement error, which likely attenuates any true dose–response relationship with caffeine.

Third, we focused on total caffeine and a broad “coffee habit” category, without distinguishing types of coffee and additives (e.g., sugar, cream, specialty drinks) or other caffeinated beverages. Different preparation methods and co-consumed ingredients may have distinct health effects that our analysis could not separate.

Future work should address these limitations by using richer exposure information (multiple recalls, food-frequency data, beverage type), applying multivariable and possibly non-linear models that adjust for key lifestyle and clinical confounders, and, ideally, analyzing longitudinal data to evaluate incident disease rather than cross-sectional biomarkers. Such extensions would allow a more rigorous assessment of whether coffee and caffeine have truly beneficial, harmful, or neutral effects on cardiometabolic health.
