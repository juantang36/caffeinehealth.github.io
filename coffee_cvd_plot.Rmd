---
title: "coffee_cvd_plot"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readr)
library(haven)
library(janitor)
library(ggplot2)
library(plotly)
library(ggpubr)
analytic = read_csv("./analytic.csv")
knitr::opts_chunk$set(echo = TRUE)
```

#### Clean and tidy CVD data
```{r tidy_cvd_data}
cvd_df = analytic |>
  rename(
    total_cholesterol = lbxtc, # unit = mg/dl
    hdl = lbdhdd, # good cholesterol, unit = mg/dl
    ldl = lbdldlm # bad cholesterol, unit = mg/dl (Martin-Hopkins)
  ) |>
  select(
    seqn, 
    coffee_habit_binary, 
    hdl, 
    ldl, 
    total_cholesterol
  ) |>
  filter(
    !is.na(hdl), 
    !is.na(ldl), 
    !is.na(total_cholesterol)
  )
```

#### Coffee_CVD_biomarkers plot
```{r cvd_plot}
# make a tidy long dataset for plotting
cvd_long = cvd_df |>
  filter(!is.na(coffee_habit_binary)) |>
  mutate(
    coffee_habit = if_else(coffee_habit_binary, "Yes", "No"),
coffee_habit = factor(coffee_habit, levels = c("No", "Yes"))
  ) |>
  pivot_longer(
    cols = c(hdl, ldl, total_cholesterol),
    names_to = "biomarker",
    values_to = "value"
  ) |>
  mutate(
    biomarker = factor(
      biomarker, 
      levels = c("hdl", "ldl", "total_cholesterol"), 
      labels = c("HDL", "LDL", "Total Cholesterol")
    )
  )

# ggplot: violin + boxplot, faceted by biomarker
p = ggplot(cvd_long, aes(x = coffee_habit, y = value, fill = coffee_habit)) +
  geom_violin(trim = FALSE, alpha = 0.6) +
  geom_boxplot(width = 0.15, outlier.alpha = 0.3) +
  facet_wrap(~ biomarker, scales = "free_y") +
  labs(
    x = "Coffee habit",
    y = "Biomarker level (mg/dL)",
    title = "CVD biomarkers by coffee habit"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 20, hjust = 1)
  )

# turn into interactive plot
p_interactive = ggplotly(p)
p_interactive
```

#### Two-sample t-test
```{r t-test}
cvd_ttest_raw = cvd_long |>
  group_by(biomarker) |>
  group_modify(~ broom::tidy(t.test(value ~ coffee_habit_binary, data = .x))) |>
  ungroup()

# clean results: convert direction to (yes-no), flip CI accordingly
cvd_ttest_clean = cvd_ttest_raw |>
  transmute(
    biomarker, 
    mean_no = estimate1, 
    mean_yes = estimate2, 
    diff_mean = estimate2 - estimate1, 
    ci_low = -conf.high, 
    ci_high = -conf.low, 
    p_value = p.value
  )

knitr::kable(cvd_ttest_clean)
```

Based on the two-sample t-tests, HDL (good cholesterol) levels were higher among coffee drinkers with a statistically significant difference (mean difference = `r round(cvd_ttest_clean$diff_mean[cvd_ttest_clean$biomarker == "HDL"], 2)` mg/dL, 95% CI: `r paste0("(", round(cvd_ttest_clean$ci_low[cvd_ttest_clean$biomarker == "HDL"], 2),", ", round(cvd_ttest_clean$ci_high[cvd_ttest_clean$biomarker == "HDL"], 2), ")")`, *p* = `r signif(cvd_ttest_clean$p_value[cvd_ttest_clean$biomarker == "HDL"], 3)`).

For LDL (bad cholesterol), the mean difference was `r round(cvd_ttest_clean$diff_mean[cvd_ttest_clean$biomarker == "LDL"], 2)` mg/dL (95% CI: `r paste0("(", round(cvd_ttest_clean$ci_low[cvd_ttest_clean$biomarker == "LDL"], 2), ", ", round(cvd_ttest_clean$ci_high[cvd_ttest_clean$biomarker == "LDL"], 2), ")")`), with *p* = `r signif(cvd_ttest_clean$p_value[cvd_ttest_clean$biomarker == "LDL"], 3)`, 
indicating that the difference was not statistically significant.

Total cholesterol was also significantly higher among coffee drinkers (mean difference = `r round(cvd_ttest_clean$diff_mean[cvd_ttest_clean$biomarker == "Total Cholesterol"], 2)` mg/dL, 95% CI: `r paste0("(", round(cvd_ttest_clean$ci_low[cvd_ttest_clean$biomarker == "Total Cholesterol"], 2), ", ", round(cvd_ttest_clean$ci_high[cvd_ttest_clean$biomarker == "Total Cholesterol"], 2), ")")`, *p* = `r signif(cvd_ttest_clean$p_value[cvd_ttest_clean$biomarker == "Total Cholesterol"], 3)`).
