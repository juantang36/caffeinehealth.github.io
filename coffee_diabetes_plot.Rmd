---
title: "coffee_diabetes"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readr)
library(haven)
library(janitor)
library(ggplot2)
library(plotly)
analytic = read_csv("./analytic.csv")
knitr::opts_chunk$set(echo = TRUE)
```

#### Create diabetes dataset
```{r}
# clean and tidy data
diabetes_df = analytic |>
  rename(
    glycohemoglobin = lbxgh, 
    insulin_uuml = lbxin, 
    glucose_mgdl = lbxglu
  ) |>
  select(
    seqn, 
    coffee_habit_binary, 
    glycohemoglobin, 
    insulin_uuml, 
    glucose_mgdl
  ) |>
  filter(
    !is.na(glycohemoglobin), 
    !is.na(insulin_uuml), 
    !is.na(glucose_mgdl)
  )
```

#### Plot
```{r bar_chart}
diabetes_long <- diabetes_df |>
  filter(!is.na(coffee_habit_binary)) |>
  mutate(
    coffee_habit = if_else(coffee_habit_binary, "Yes", "No"),
coffee_habit = factor(coffee_habit, levels = c("No", "Yes"))
  ) |>
  select(coffee_habit, glycohemoglobin, insulin_uuml, glucose_mgdl) |>
  pivot_longer(
    cols = c(glycohemoglobin, insulin_uuml, glucose_mgdl),
    names_to = "biomarker",
    values_to = "value"
  )

summary_df <- diabetes_long |>
  group_by(coffee_habit, biomarker) |>
  summarize(
    mean_value = mean(value, na.rm = TRUE),
    se = sd(value, na.rm = TRUE) / sqrt(sum(!is.na(value))),
    n = sum(!is.na(value)),
    .groups = "drop")
p <- ggplot(summary_df,
            aes(x = coffee_habit, y = mean_value, fill = coffee_habit)) +
  geom_col(width = 0.6) +
  geom_errorbar(aes(ymin = mean_value - 1.96 * se,
                    ymax = mean_value + 1.96 * se),
                width = 0.15) +
  facet_wrap(~ biomarker, scales = "free_y") +
  labs(
    x = "Coffee habit",
    y = "Mean diabetes biomarker level",
    fill = "Coffee habit"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 20, hjust = 1)
  )
ggplotly(p)
```

#### Two-sample t-test
outcome/biomarkers: 
- Glycohemoglobin
- Insulin (uu/ml)
- Glucose (mg/dL)

H_0: mean biomarker is the same in coffee vs. no-coffee
H_1: mean biomarkers is different between the two groups
```{r t_test}
# run two-sample t-tests by biomarker
ttest_results = diabetes_long |>
  group_by(biomarker) |>
  group_modify(~ broom::tidy(t.test(value ~ coffee_habit, data = .x))) |>
  ungroup()

# clean up column names
ttest_results_clean = ttest_results |>
  transmute(
    biomarker,
    mean_no = estimate1,
    mean_yes = estimate2,
    diff_mean = estimate2 - estimate1,
    ci_low = -conf.high,
    ci_high = -conf.low,
    p_value = p.value
  )

# tidy the test result
ttest_results_clean |>
  mutate(
    across(
      c(mean_no, mean_yes, diff_mean, ci_low, ci_high),
      ~ round(.x, 2)
    ),
    p_value = signif(p_value, 3)
  ) |>
  knitr::kable(
    caption = "Difference in mean diabetes biomarkers between coffee habit groups"
  )
```

Among participants with complete diabetes biomarker data (N = `r nrow(diabetes_df)`), we compared
glycohemoglobin, fasting glucose, and insulin levels between those who drank coffee on both recall days (with coffee habit)
and those who did not drink coffee (without coffee habit).

#### Results: Diabetes Biomarkers and Coffee Consumption

We compared fasting glucose, glycohemoglobin (HbA1c), and fasting insulin between adults who did not drink coffee (“No”) and those who drank coffee on both days (“Yes”).

**Fasting glucose:**  
The mean fasting glucose level was `r round(ttest_results_clean$mean_no[ttest_results_clean$biomarker=="glucose_mgdl"], 2)` mg/dL in the no_coffee group and `r round(ttest_results_clean$mean_yes[ttest_results_clean$biomarker=="glucose_mgdl"], 2)` mg/dL in the coffee group.  
The mean difference (Yes − No) was  **`r round(ttest_results_clean$diff_mean[ttest_results_clean$biomarker=="glucose_mgdl"], 2)` mg/dL** with a 95% CI of  (`r round(ttest_results_clean$ci_low[ttest_results_clean$biomarker=="glucose_mgdl"], 2)`, `r round(ttest_results_clean$ci_high[ttest_results_clean$biomarker=="glucose_mgdl"], 2)`)  and a p-value of `r signif(ttest_results_clean$p_value[ttest_results_clean$biomarker=="glucose_mgdl"], 3)`.  
This indicates a statistically significant increase in fasting glucose among coffee drinkers.

**Glycohemoglobin (HbA1c):**  
HbA1c averaged `r round(ttest_results_clean$mean_no[ttest_results_clean$biomarker=="glycohemoglobin"], 2)`% in the No group and  
`r round(ttest_results_clean$mean_yes[ttest_results_clean$biomarker=="glycohemoglobin"], 2)`% in the Yes group.  
The mean difference was **`r round(ttest_results_clean$diff_mean[ttest_results_clean$biomarker=="glycohemoglobin"], 2)`%**  (95% CI:  `r round(ttest_results_clean$ci_low[ttest_results_clean$biomarker=="glycohemoglobin"], 2)`,  `r round(ttest_results_clean$ci_high[ttest_results_clean$biomarker=="glycohemoglobin"], 2)`)  with a p-value of `r signif(ttest_results_clean$p_value[ttest_results_clean$biomarker=="glycohemoglobin"], 3)`.  
This small but statistically significant increase suggests slightly higher HbA1c in coffee drinkers.

**Fasting insulin:**  
The mean insulin level was  `r round(ttest_results_clean$mean_no[ttest_results_clean$biomarker=="insulin_uuml"], 2)` μU/mL in the No group and `r round(ttest_results_clean$mean_yes[ttest_results_clean$biomarker=="insulin_uuml"], 2)` μU/mL in the Yes group.  
The mean difference (Yes − No) was  **`r round(ttest_results_clean$diff_mean[ttest_results_clean$biomarker=="insulin_uuml"], 2)` μU/mL**  with a 95% CI of (`r round(ttest_results_clean$ci_low[ttest_results_clean$biomarker=="insulin_uuml"], 2)`, `r round(ttest_results_clean$ci_high[ttest_results_clean$biomarker=="insulin_uuml"], 2)`)  and a p-value of `r signif(ttest_results_clean$p_value[ttest_results_clean$biomarker=="insulin_uuml"], 3)`.  
This reflects a statistically significant decrease in fasting insulin among coffee drinkers.
